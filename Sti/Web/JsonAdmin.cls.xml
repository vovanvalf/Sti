<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Sti.Web.JsonAdmin">
<Description>
Handling of BrokerAdmin</Description>
<Super>Json</Super>
<TimeCreated>63098,81450.05769</TimeCreated>

<Method name="CheckAdmin">
<Description>
Проверить права доступа, авторизация</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>isLogin:%Boolean</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if (isLogin = 1){
		set data = ##class(%ZEN.proxyObject).%New()
		set data.user = $USERNAME
	
		if (##class(Sti.Data.Internship).CheckDeletePrivilege() = $$$OK){
			set data.privileges = "all"
		}
		else{
			set data.privileges = "read"
		}
		
		do data.%ToJSON()
		
		q $$$OK
	}

    #; Don't want the session token
    Set %response.OutputSessionToken=0
            
    #; Set the Http Status
    Set %response.Status="401 Unauthorized"
        
    #; Write out the header
    Do %response.WriteHTTPHeader()
            
    Set %session.EndSession=1

	do %session.Logout()	
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetOrder">
<Description>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////                   ЗАЯВКИ        //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Получить заявку по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		do ##class(Sti.Data.Order).%OpenId(id).ConvertToProxyObject().%ToJSON()
	}
	catch(ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="DeleteOrder">
<Description>
Удалить заявку по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	quit ##class(Sti.Data.Order).%DeleteId(id)
]]></Implementation>
</Method>

<Method name="GetOrders">
<Description>
Все заявки</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		set proxy = ##class(%ZEN.proxyObject).%New()
		set proxy.children = ##class(%ListOfObjects).%New() 
		
		&sql(DECLARE OrCur CURSOR FOR 
		 	 SELECT ID
		 	 FROM Sti_Data.Order)	
		
		&sql(OPEN OrCur)
		for  
		{	
			&sql(FETCH OrCur INTO :id) 
			quit:(SQLCODE '= 0)
			
			do proxy.children.Insert(##class(Sti.Data.Order).%OpenId(id).ConvertToProxyObject())
		}
		
		&sql(CLOSE OrCur)
		
		do proxy.%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetOrdersForGrid">
<Description>
Получить все заявки для таблицы[GRID]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject($ZCVT(%request.Content.Read(10000000), "I", "UTF8"),,.params, 1))
      	
      	set whereCondition = ""
      	
      	do ..GetProxyObjectsForGrid("SELECT ID FROM Sti_Data.Order", "Sti.Data.Order", params, whereCondition).%ToJSON()
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="GetIntern">
<Description>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////                   СТАЖЁРЫ       //////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Получить стажера по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		do ##class(Sti.Data.Intern).%OpenId(id).ConvertToProxyObject().%ToJSON()
	}
	catch(ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="SaveIntern">
<Description>
Создать / сохранить стажера</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	
	try{
		// Преобразовали входную строку JSON в объект proxyObject
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.data, 1))
      	
      	// Открываем студента по ИД
      	set intern = ##class(Sti.Data.Intern).%OpenId(data.id,,.st)
      	
      	// Открыть не удалось - создаем
      	if $$$ISERR(st) set intern = ##class(Sti.Data.Intern).%New()
        
      	set intern.LastName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.lastName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue") 
      	set intern.FirstName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.firstName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue")
      	set intern.MiddleName =##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.middleName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue")
      	set intern.Email = $ZCONVERT(data.email, "I", "UTF8")
      	set intern.Phone = $ZCONVERT(data.phone, "I", "UTF8")
      	set intern.Skype = $ZCONVERT(data.skype, "I", "UTF8")
      	set intern.Resume = $ZCONVERT(data.resume, "I", "UTF8")
      	set intern.IsInNewsletter = data.isInNewsletter = $$$YES
      	set intern.CacheExperience = $ZCONVERT(data.cacheExperience, "I", "UTF8")
      	set intern.EnsembleExperience = $ZCONVERT(data.ensembleExperience, "I", "UTF8")
      	set intern.DeepseeExperience = $ZCONVERT(data.deepseeExperience, "I", "UTF8")
      	set intern.TetMark = $ZCONVERT(data.tetMark, "I", "UTF8")
      	set intern.Chair = $ZCONVERT(data.chair, "I", "UTF8")
      	set intern.Faculty = $ZCONVERT(data.faculty, "I", "UTF8")
      	set intern.BirthDate=$ZDATEH(data.birthDate, 15)
    	
	set intern.PetMark = ##class(Sti.Data.PETMark).%OpenId(data.petMark.id,,.st)
	if $$$ISERR(st) {set pet = ##class(Sti.Data.PETMark).%New() set data.petMark.id=1}
    set pet = ##class(Sti.Data.PETMark).%New()
	set pet = ##class(Sti.Data.PETMark).%OpenId(data.petMark.id,3,.Status)
	set intern.PetMark=pet
	
	set intern.EngMark = ##class(Sti.Data.ENGMark).%OpenId(data.engMark.id,,.st)
	if $$$ISERR(st) {set eng = ##class(Sti.Data.ENGMark).%New() set data.engMark.id=1}
    set eng = ##class(Sti.Data.ENGMark).%New()
	set eng = ##class(Sti.Data.ENGMark).%OpenId(data.engMark.id,3,.Status)
	set intern.EngMark=eng
		     	
      	set intern.City = ##class(Sti.Data.Region).%OpenId(data.city.id,,.st)
		if $$$ISERR(st) set city = ##class(Sti.Data.Region).%New()
		set city = ##class(Sti.Data.Region).%OpenId(data.city.id,3,.Status)
		set intern.City=city
		
      	set intern.Internship=  ##class(Sti.Data.Internship).%OpenId(data.internship.id)
        set intern.University = ##class(Sti.Data.University).%OpenId(data.university.id)
		
		$$$THROWONERROR(st, intern.%Save())
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="CreateIntern">
<Description>
Создать стажера из заявки</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	
	try{
		// Преобразовали входную строку JSON в объект proxyObject
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.data, 1))
      	
        set intern = ##class(Sti.Data.Intern).%New()
        
      	set intern.LastName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.lastName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue") 
      	set intern.FirstName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.firstName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue")
      	set intern.MiddleName =##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.middleName, "I", "UTF8"), "Sti.Data.Localization.Translation;PersonLTextValue")
      	set intern.Email = $ZCONVERT(data.email, "I", "UTF8")
      	set intern.Phone = $ZCONVERT(data.phone, "I", "UTF8")
      	set intern.Skype = $ZCONVERT(data.skype, "I", "UTF8")
      	set intern.Resume = $ZCONVERT(data.resume, "I", "UTF8")
      	set intern.IsInNewsletter = data.isInNewsletter = $$$YES
      	set intern.CacheExperience = $ZCONVERT(data.cacheExperience, "I", "UTF8")
      	set intern.EnsembleExperience = $ZCONVERT(data.ensembleExperience, "I", "UTF8")
      	set intern.DeepseeExperience = $ZCONVERT(data.deepseeExperience, "I", "UTF8")
      	set intern.TetMark = $ZCONVERT(data.tetMark, "I", "UTF8")
      	set intern.BirthDate=$ZDATEH(data.birthDate, 15)
      	set intern.Chair = $ZCONVERT(data.chair, "I", "UTF8")
      	set intern.Faculty = $ZCONVERT(data.faculty, "I", "UTF8")
    	
	set intern.PetMark = ##class(Sti.Data.PETMark).%OpenId(data.petMark.id,,.st)
	if $$$ISERR(st) {set pet = ##class(Sti.Data.PETMark).%New() set data.petMark.id=1}
    set pet = ##class(Sti.Data.PETMark).%New()
	set pet = ##class(Sti.Data.PETMark).%OpenId(data.petMark.id,3,.Status)
	set intern.PetMark=pet
	
	set intern.EngMark = ##class(Sti.Data.ENGMark).%OpenId(data.engMark.id,,.st)
	if $$$ISERR(st) {set eng = ##class(Sti.Data.ENGMark).%New() set data.engMark.id=1}
    set eng = ##class(Sti.Data.ENGMark).%New()
	set eng = ##class(Sti.Data.ENGMark).%OpenId(data.engMark.id,3,.Status)
	set intern.EngMark=eng
		     	
      	set intern.City = ##class(Sti.Data.Region).%OpenId(data.city.id,,.st)
		if $$$ISERR(st) set city = ##class(Sti.Data.Region).%New()
		set city = ##class(Sti.Data.Region).%OpenId(data.city.id,3,.Status)
		set intern.City=city
		
      	set intern.Internship=  ##class(Sti.Data.Internship).%OpenId(data.internship.id)
        set intern.University = ##class(Sti.Data.University).%OpenId(data.university.id)
		
		$$$THROWONERROR(st, intern.%Save())
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="DeleteIntern">
<Description>
Удалить стажера по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	quit ##class(Sti.Data.Intern).%DeleteId(id)
]]></Implementation>
</Method>

<Method name="GetInterns">
<Description>
Все стажеры</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		set proxy = ##class(%ZEN.proxyObject).%New()
		set proxy.children = ##class(%ListOfObjects).%New() 
		
		&sql(DECLARE IntCur CURSOR FOR 
		 	 SELECT ID
		 	 FROM Sti_Data.Intern)	
		
		&sql(OPEN IntCur)
		for  
		{	
			&sql(FETCH IntCur INTO :id) 
			quit:(SQLCODE '= 0)
			
			do proxy.children.Insert(##class(Sti.Data.Intern).%OpenId(id).ConvertToProxyObject())
		}
		
		&sql(CLOSE IntCur)
		
		do proxy.%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetInternsForGrid">
<Description>
Получить всех стажеров для таблицы[GRID]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject($ZCVT(%request.Content.Read(10000000), "I", "UTF8"),,.params, 1))
      	
      	set whereCondition = ""
      	
      	do ..GetProxyObjectsForGrid("SELECT ID FROM Sti_Data.Intern", "Sti.Data.Intern", params, whereCondition).%ToJSON()
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="DeleteUniversity">
<Description>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////                УНИВЕРСИТЕТЫ        ///////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Удалить университет по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	quit ##class(Sti.Data.University).%DeleteId(id)
]]></Implementation>
</Method>

<Method name="GetUniversityInterns">
<Description>
Все стажеры университета</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>unId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		set proxy = ##class(%ZEN.proxyObject).%New()
		set proxy.children = ##class(Sti.Data.University).%OpenId(unId).ConvertToProxyObject(1).Interns
		do proxy.%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetUniversity">
<Description>
Получить университет по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{	
		do ##class(Sti.Data.University).%OpenId(id).ConvertToProxyObject().%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetUniversitiesForGrid">
<Description>
Получить все университеты для таблицы[GRID]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject($ZCVT(%request.Content.Read(10000000), "I", "UTF8"),,.params, 1))
      	
      	set whereCondition = ""
      	
      	do ..GetProxyObjectsForGrid("SELECT ID FROM Sti_Data.University", "Sti.Data.University", params, whereCondition).%ToJSON()
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="SaveUniversity">
<Description>
Создать / сохранить университет</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.data, 1))
      	
      	set university = ##class(Sti.Data.University).%OpenId(data.id,,.st)
      	
      	if $$$ISERR(st) set university = ##class(Sti.Data.University).%New()
		set university.FullName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.fullName, "I", "UTF8"))
		set university.ShortName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.shortName, "I", "UTF8"))
		set university.Address = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.address, "I", "UTF8"))
		set university.Web = $ZCONVERT(data.web, "I", "UTF8")
	
		set university.Curator = ##class(Sti.Data.Employee).%OpenId(data.curator.id,,.st)
		if $$$ISERR(st) set curator = ##class(Sti.Data.Employee).%New()
		set curator = ##class(Sti.Data.Employee).%New()
		set curator.LastName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.lastName, "I", "UTF8"))
		set curator.FirstName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.firstName, "I", "UTF8"))
		set curator.MiddleName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.middleName, "I", "UTF8"))
		set curator.Email = data.curator.email
		set curator.Phone = data.curator.phone
		
		$$$THROWONERROR(st,curator.%Save() )
		
		set university.Curator = curator
		
		set university.City = ##class(Sti.Data.Region).%OpenId(data.city.id,,.st)
		if $$$ISERR(st) set city = ##class(Sti.Data.Region).%New()
		set city = ##class(Sti.Data.Region).%OpenId(data.city.id,3,.Status)
		set university.City=city
	
		$$$THROWONERROR(st, university.%Save() )
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="GetCompanies">
<Description>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////                   КОМПАНИИ        ////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Все компании</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		set proxy = ##class(%ZEN.proxyObject).%New()
		set proxy.children = ##class(%ListOfObjects).%New() 
		
		&sql(DECLARE CoCur CURSOR FOR 
		 	 SELECT ID
		 	 FROM Sti_Data."Company")	
		
		&sql(OPEN CoCur)
		for  
		{	
			&sql(FETCH CoCur INTO :id) 
			quit:(SQLCODE '= 0)
			
			do proxy.children.Insert(##class(Sti.Data.Company).%OpenId(id).ConvertToProxyObject())
		}
		
		&sql(CLOSE CoCur)
		
		do proxy.%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="DeleteCompany">
<Description>
Удалить компанию по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	quit ##class(Sti.Data.Company).%DeleteId(id)
]]></Implementation>
</Method>

<Method name="GetCompanyInternship">
<Description>
Все стажировки компании</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>coId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		set proxy = ##class(%ZEN.proxyObject).%New()
		// Открываем универ, конвертируем в proxy(полностью) и возвращаем стажеров
		set proxy.children = ##class(Sti.Data.Company).%OpenId(coId).ConvertToProxyObject(1).Interns
		do proxy.%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetCompany">
<Description>
Получить компанию по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{	
		do ##class(Sti.Data.Company).%OpenId(id).ConvertToProxyObject().%ToJSON()
	}
	catch (ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="GetCompaniesForGrid">
<Description>
Получить все компании для таблицы[GRID]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject($ZCVT(%request.Content.Read(10000000), "I", "UTF8"),,.params, 1))
      	
      	set whereCondition = ""
      	
      	do ..GetProxyObjectsForGrid("SELECT ID FROM Sti_Data.Company", "Sti.Data.Company", params, whereCondition).%ToJSON()
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="SaveCompany">
<Description>
Создать / сохранить компанию</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.data, 1))
      	
      	set company = ##class(Sti.Data.Company).%OpenId(data.id,,.st)
      	     	
      	if $$$ISERR(st) set company = ##class(Sti.Data.Company).%New()
      	set company.FullName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.fullName, "I", "UTF8"))
		set company.ShortName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.shortName, "I", "UTF8"))
		set company.LegalAddress = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.legalAddress, "I", "UTF8"))
		set company.MailAddress = data.mailAddress
		set company.WebSite=data.webSite
		
		set company.Contact = ##class(Sti.Data.Employee).%OpenId(data.curator.id,,.st)
		if $$$ISERR(st) set curator = ##class(Sti.Data.Employee).%New()
		set curator = ##class(Sti.Data.Employee).%New()
		set curator.LastName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.contact.lastName, "I", "UTF8"))
		set curator.FirstName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.contact.firstName, "I", "UTF8"))
		set curator.MiddleName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.contact.middleName, "I", "UTF8"))
		set curator.Email = data.contact.email
		set curator.Phone = data.contact.phone
		
		$$$THROWONERROR(st,curator.%Save() )
		
		set company.Contact = curator
		
	
		$$$THROWONERROR(st, company.%Save())
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="GetInternship">
<Description>
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////                  СТАЖИРОВКИ        ///////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Получить стажировку по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		do ##class(Sti.Data.Internship).%OpenId(id).ConvertToProxyObject().%ToJSON()
	}
	catch(ex){
		set st = ex.AsStatus()
	}
	
	quit st
]]></Implementation>
</Method>

<Method name="SaveInternship">
<Description>
Создать / сохранить стажировку</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	
	try{
		// Преобразовали входную строку JSON в объект proxyObject
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(%request.Content,,.data, 1))
      	
      	// Открываем студента по ИД
      	set internship = ##class(Sti.Data.Internship).%OpenId(data.id,,.st)
      	
      	// Открыть не удалось - создаем
      	if $$$ISERR(st) set internship = ##class(Sti.Data.Internship).%New()
        
        
        set internship.Name = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.name, "I", "UTF8"))
		set internship.DateBegin=$ZDATEH(data.dateBegin, 15)
		set internship.DateEnd=$ZDATEH(data.dateEnd, 15)
		set internship.MaxPeople=data.maxPeople
		set internship.Street= ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.street, "I", "UTF8"))
		set internship.Room=data.room
		set internship.IsInUse=data.isInUse=$$$YES
		
		set internship.Curator = ##class(Sti.Data.Employee).%OpenId(data.curator.id,,.st)
		if $$$ISERR(st) set curator = ##class(Sti.Data.Employee).%New()
		set curator = ##class(Sti.Data.Employee).%New()
		set curator.LastName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.lastName, "I", "UTF8"))
		set curator.FirstName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.firstName, "I", "UTF8"))
		set curator.MiddleName = ##class(Sti.Data.Localization.LText).Create($ZCONVERT(data.curator.middleName, "I", "UTF8"))
		set curator.Email = data.curator.email
		set curator.Phone = data.curator.phone
		
		$$$THROWONERROR(st,curator.%Save() )
		set internship.Curator = curator
		 	
		set internship.City = ##class(Sti.Data.Region).%OpenId(data.city.id,,.st)
		if $$$ISERR(st) set city = ##class(Sti.Data.Region).%New()
		set city = ##class(Sti.Data.Region).%OpenId(data.city.id,3,.Status)
		set internship.City=city
				
		set internship.Company = ##class(Sti.Data.Company).%OpenId(data.company.id)
		
		$$$THROWONERROR(st, internship.%Save())
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>

<Method name="DeleteInternship">
<Description>
Удалить стажировку по ИД</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	quit ##class(Sti.Data.Internship).%DeleteId(id)
]]></Implementation>
</Method>

<Method name="GetInternshipsForGrid">
<Description>
Получить все стажировки для таблицы[GRID]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	try{
		$$$THROWONERROR(st, ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject($ZCVT(%request.Content.Read(10000000), "I", "UTF8"),,.params, 1))
      	
      	set whereCondition = ""
      	
      	do ..GetProxyObjectsForGrid("SELECT ID FROM Sti_Data.Internship", "Sti.Data.Internship", params, whereCondition).%ToJSON()
	}
	catch ex {
		set st = ex.AsStatus()
	}

	quit st
]]></Implementation>
</Method>
</Class>
</Export>
