<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="sti/js/controllers/AllUniversityCtrl.js" application="/csp/sti/" default="1"><![CDATA[
'use strict';
/*===========================================================================================
Все университеты
===========================================================================================*/

controllersModule.controller('AllUniversityCtrl', function($scope, $location, UniversitySrvc, InternSrvc){
       $scope.menu.selectMenu($scope.menu.pages.universities);
		$scope.universitiesTable = {state: {}};

		$scope.init = function(){
 
        $scope.universitiesTable.columns = [
                          {name: 'Университет', sqlName: 'FullName->Value', isSorted: true, isSortable: true, isDown: true, isSearched: true, isSearchable: true},
                          {name: 'Регион', sqlName: 'City->ParentRegion->Name->Value', isSorted: false, isSortable: true, isDown: true, isSearched: false, isSearchable: true},
                          {name: 'Город', sqlName: 'City->Name->Value', isSorted: false, isSortable: true, isDown: true, isSearched: false, isSearchable: true},
                           ];
        $scope.universitiesTable.properties = [
        				  	{
	        				  	name: 'fullName',
	        				  	cellStyle: {textAlign: 'left'},
	        				  	cellSelectable: false,
	        					getCssClass: function(item){ 
                                    return '';
                                },
	        				},
	        				{
	        				  	name: 'city.parentName',
	        				  	cellStyle: {textAlign: 'left'},
	        				  	cellSelectable: false,
	        				  	getCssClass: function(item){ 
                                    return '';
                                }
	        				},
	        				{
	        				  	name: 'city.name',
	        				  	cellStyle: {textAlign: 'left'},
	        				  	cellSelectable: false,
	        				  	getCssClass: function(item){ 
                                    return '';
                                }
	        				}]; 
	        				
        $scope.universitiesTable.pageSize = 7;
        $scope.universitiesTable.pageCurr = 1;
        $scope.universitiesTable.itemsTotal = 0;
        $scope.universitiesTable.selectedItems = [];
        $scope.universitiesTable.multiSelectMode = false;
        $scope.universitiesTable.forciblyUpdate = 0;
        $scope.universitiesTable.refresh();
    };

    // 
    $scope.universitiesTable.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        UniversitySrvc.getAllForGrid(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, {}).then(
            function(data){
	            data = data.children;
                $scope.universitiesTable.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.universitiesTable.itemsTotal = data.itemsTotal;
                $scope.universitiesTable.items = data.items;
            },
            function(data){
                console.log('Ошибка!!!!', data);
            });
    };

	$scope.universitiesTable.refresh = function(){ 
        $scope.universitiesTable.forciblyUpdate++; 
    };
    
    $scope.universitiesTable.add = function(){
        $location.path('/university/'); 
    };

    $scope.universitiesTable.edit = function(item){
        $location.path('/university/' + item.id);
    };

    $scope.universitiesTable.remove = function(item){       
            UniversitySrvc.remove(item.id).then(
                function(data){
                    $scope.universitiesTable.selectedItems = [];
                    $scope.universitiesTable.refresh();
                    $scope.alert = UtilsSrvc.getAlert('Готово!', 'Университет удален.', 'success', true);
                },
                function(data, status, headers, config){
                    $scope.stalert = {title: 'Внимание!', msg: data, cssClass: 'alert alert-error', visible: true};
                });
            
    };
    
    $scope.universitiesTable.onSelect = function(item){
        console.log('Selected row ',item);       
    };

    $scope.universitiesTable.onSelectCell = function(item, property){
        /*if (!item) return;
        property.onClickCell(item);*/
    };


	$scope.init();
	
    
    /*$scope.page = {};

    // Инициализация данных
    $scope.page.init = function(){
        /* Данные для таблицы с универами, объект будет передан в компонент dmgrid
           Заголовок таблицы. 
           Сss класс для таблицы. 
           Имена колонок и имя свойства для доступа к значению.
           Методы для работы с данными 
        $scope.page.ungrid = {
            caption: 'Университеты',
            cssClass: 'table table-bordered table-hover',
            columns: [{name: 'Университет', property: 'fullName'},
            		  {name: 'Страна', property: 'city.parentName'},
            		  {name: 'Город', property: 'city.name'}],
            add: $scope.page.addUniversity,
            edit: $scope.page.editUniversity,
            remove: $scope.page.removeUniversity
        };
        // Загрузить все университеты из БД
        $scope.page.loadUniversities();
   };
  

    // Загрузить все университеты из БД
    $scope.page.loadUniversities = function(){
        UniversitySrvc.getAll().then(
            function(data){
                // Успех. Передать данные в грид
                $scope.page.ungrid.items = data.children;
            },
            function(data, status, headers, config){
                // Ошибка
                $scope.page.unalert = {title: 'Внимание!', msg: 'Университеты не загружены. ' + data, cssClass: 'alert alert-error', visible: true};  
            });      
    };

    // Загрузить стажеров университетов
    $scope.page.loadUniversityInterns = function(university){
        UniversitySrvc.getInterns(university.id).then(
            function(data){
                university.universities = data.children;
            },
            function(data, status, headers, config){
                $scope.page.unalert = {title: 'Внимание!', msg: 'Университеты не загружены. ' + data, cssClass: 'alert alert-error', visible: true};  
            });       
    };

    // Добавить универ. Переход на другую страницу
    $scope.page.addUniversity = function(){
        $location.path('/university/');
    };

    // Редактировать универ. Переход на другую страницу
    $scope.page.editUniversity = function(university){
        $location.path('/university/' + university.id);
    };

    // Удалить универ
    $scope.page.removeUniversity = function(university){
        UniversitySrvc.remove(university.id).then(
            function(data){
                $scope.page.gralert = {title: 'Готово!', msg: 'Университет удален.', cssClass: 'alert alert-success', visible: true, closeTimeout: 1500};
                $scope.page.loadUniversities();
                $scope.page.ungrid.selected = null;
            },
            function(data, status, headers, config){
                $scope.page.gralert = {title: 'Внимание!', msg: data, cssClass: 'alert alert-error', visible: true};  
            });
    };
    $scope.page.init(); */
});

]]></CSP>
</Export>
