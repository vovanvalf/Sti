<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Src.Utils.Email.Sender">
<Abstract>1</Abstract>
<TimeCreated>63698,44050.781835</TimeCreated>

<Method name="Send">
<ClassMethod>1</ClassMethod>
<FormalSpec>email:Src.Utils.Email.Email,smtp:%Net.SMTP=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	if ('$IsObject(smtp)){
		set smtp = ..GetSmtpServer()
	}
	
	try
	{
		set mail=##class(%Net.MailMessage).%New()
    	set mail.From = "ls@intersystems.ru"
    	set mail.Subject = email.Subject
    	set mail.Charset = "utf-8"
    	set mail.IsHTML = 1
    	set mail.ContentType = "text/html"
    	do mail.TextData.Write(email.Message)
    	
	    //do mail.To.Insert(email.Recipient)
	    do mail.To.Insert("crraay@gmail.com")
  	
    	$$$THROWONERROR(st, smtp.Send(mail))
    	
    	set email.WasSent = 1
		do email.%Save()
	}
	catch (ex){
		set st = ex.AsStatus()
  	}
  	
	quit st
]]></Implementation>
</Method>

<Method name="SendAll">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	set resultSet = ##class(%ResultSet).%New("%DynamicQuery:SQL")
	$$$THROWONERROR(st, resultSet.Prepare("SELECT ID FROM Src_Utils_Email.Email WHERE WasSent = 0"))
	
	set result = resultSet.Execute()
	
	set smtp = ..GetSmtpServer()
	
	while (resultSet.Next() '= 0)
	{
		do ..Send(resultSet.GetObject(), smtp)
	}
	
	return st
]]></Implementation>
</Method>

<Method name="GetSmtpServer">
<ClassMethod>1</ClassMethod>
<ReturnType>%Net.SMTP</ReturnType>
<Implementation><![CDATA[
	//Вынести в настройки, уточнить данные
	set auth=##class(%Net.Authenticator).%New()
	set auth.MechanismList = "LOGIN"
	set auth.UserName = "evshvarov"
	set auth.Password = "rfitMail12"
	
	set smtp = ##class(%Net.SMTP).%New()
	set smtp.smtpserver = "mail.intersystems.ru"
	set smtp.port = 25
	set smtp.authenticator = auth
	
	return smtp
]]></Implementation>
</Method>
</Class>
</Export>
